<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Rekapitulasi Pengeluaran Profesional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 500; transition: background-color 0.2s; cursor: pointer; }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-secondary { background-color: #e5e7eb; color: #374151; }
        .btn-secondary:hover { background-color: #d1d5db; }
        .input-group { display: none; }
        .input-group.active { display: grid; }
        .form-grid { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        @media (min-width: 768px) { .form-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
        @media (min-width: 1024px) { .form-grid { grid-template-columns: repeat(4, minmax(0, 1fr)); } }
        
        /* Modal Styles */
        .modal-overlay {
            transition: opacity 0.2s ease-in-out;
        }
        .modal-container {
            transition: transform 0.2s ease-in-out;
        }

        /* Print Styles */
        @media print {
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; margin: 0; }
            .no-print { display: none !important; }
            .a4-container { margin: 0; box-shadow: none; border: none; }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-5xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Aplikasi Rekapitulasi Pengeluaran</h1>
            <p class="text-gray-500 mt-1">Catat dan kelola pengeluaran Anda dengan cerdas.</p>
        </header>

        <!-- Project Info Section -->
        <div class="card p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Informasi Proyek</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="project-name" class="block text-sm font-medium text-gray-600 mb-1">Proyek</label>
                    <input type="text" id="project-name" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="project-location" class="block text-sm font-medium text-gray-600 mb-1">Lokasi</label>
                    <input type="text" id="project-location" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="project-activity" class="block text-sm font-medium text-gray-600 mb-1">Kegiatan/Sub-Judul Laporan</label>
                    <input type="text" id="project-activity" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="project-personnel" class="block text-sm font-medium text-gray-600 mb-1">Nama Personil</label>
                    <input type="text" id="project-personnel" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </div>
        </div>

        <!-- Budget Section -->
        <div class="card p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Sumber Dana</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="initial-budget" class="block text-sm font-medium text-gray-600 mb-1">Total Uang Diterima</label>
                    <input type="text" id="initial-budget" inputmode="numeric" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Rp 0">
                </div>
                <div>
                    <label for="budget-date" class="block text-sm font-medium text-gray-600 mb-1">Tanggal Diterima</label>
                    <input type="text" id="budget-date" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="dd/mm/yyyy">
                </div>
                <div class="md:self-end">
                    <button id="set-budget-btn" class="btn btn-primary w-full"><i class="fas fa-save mr-2"></i>Atur Budget</button>
                </div>
            </div>
        </div>

        <!-- Summary Section -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="card p-5 flex items-center">
                <div class="bg-blue-100 text-blue-600 p-4 rounded-full mr-4"><i class="fas fa-wallet fa-2x"></i></div>
                <div>
                    <p class="text-gray-500 text-sm">Total Budget</p>
                    <h3 id="summary-budget" class="text-2xl font-bold text-gray-800">Rp 0</h3>
                </div>
            </div>
            <div class="card p-5 flex items-center">
                <div class="bg-red-100 text-red-600 p-4 rounded-full mr-4"><i class="fas fa-arrow-down-wide-short fa-2x"></i></div>
                <div>
                    <p class="text-gray-500 text-sm">Total Pengeluaran</p>
                    <h3 id="summary-expenses" class="text-2xl font-bold text-gray-800">Rp 0</h3>
                </div>
            </div>
            <div class="card p-5 flex items-center">
                <div class="bg-green-100 text-green-600 p-4 rounded-full mr-4"><i class="fas fa-coins fa-2x"></i></div>
                <div>
                    <p class="text-gray-500 text-sm">Sisa Budget</p>
                    <h3 id="summary-balance" class="text-2xl font-bold text-gray-800">Rp 0</h3>
                </div>
            </div>
        </div>
        
        <!-- Expense Form -->
        <div class="card p-6 mb-8">
            <h2 id="form-title" class="text-xl font-semibold text-gray-700 mb-4">Tambah Pengeluaran Baru</h2>
            <form id="expense-form">
                <input type="hidden" id="expense-id">
                <div class="grid form-grid gap-4 items-end">
                    <div>
                        <label for="expense-category" class="block text-sm font-medium text-gray-600 mb-1">1. Pilih Kategori</label>
                        <select id="expense-category" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                            <option value="">-- Pilih --</option>
                            <option value="Uang Supervisi">Uang Supervisi</option>
                            <option value="Transportasi">Transportasi</option>
                            <option value="Konsumsi">Konsumsi</option>
                            <option value="Akomodasi">Akomodasi</option>
                            <option value="Komunikasi">Komunikasi</option>
                            <option value="Lainnya">Lainnya</option>
                        </select>
                    </div>

                    <!-- Standard Inputs -->
                    <div id="standard-inputs" class="input-group col-span-full gap-4">
                        <div>
                            <label for="standard-date" class="block text-sm font-medium text-gray-600 mb-1">2. Tanggal</label>
                            <input type="text" id="standard-date" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="dd/mm/yyyy">
                        </div>
                        <div class="lg:col-span-2">
                            <label for="standard-description" id="standard-description-label" class="block text-sm font-medium text-gray-600 mb-1">3. Keterangan</label>
                            <input type="text" id="standard-description" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="standard-amount" class="block text-sm font-medium text-gray-600 mb-1">4. Jumlah</label>
                            <input type="text" id="standard-amount" inputmode="numeric" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Rp 0">
                        </div>
                    </div>
                    
                    <!-- Supervisi Inputs -->
                    <div id="supervisi-inputs" class="input-group col-span-full gap-4">
                        <div>
                            <label for="supervisi-name" class="block text-sm font-medium text-gray-600 mb-1">2. Nama Supervisi</label>
                            <input type="text" id="supervisi-name" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="lg:col-span-3">
                            <label class="block text-sm font-medium text-gray-600 mb-1">3. Pilih Periode</label>
                            <div class="flex items-center space-x-2">
                                <input type="text" id="supervisi-start-date" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="dd/mm/yyyy">
                                <span class="text-gray-500">s/d</span>
                                <input type="text" id="supervisi-end-date" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="dd/mm/yyyy">
                            </div>
                        </div>
                        <div>
                            <label for="supervisi-rate-work" class="block text-sm font-medium text-gray-600 mb-1">4. Nom. Hari Kerja</label>
                            <input type="text" id="supervisi-rate-work" inputmode="numeric" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Rp 0">
                        </div>
                        <div>
                            <label for="supervisi-rate-holiday" class="block text-sm font-medium text-gray-600 mb-1">5. Nom. Hari Libur</label>
                            <input type="text" id="supervisi-rate-holiday" inputmode="numeric" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Rp 0">
                        </div>
                         <div class="flex items-center space-x-2">
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">Jml Hari</label>
                                <input type="text" id="supervisi-day-count-work" class="w-full p-2 border-gray-300 rounded-lg bg-gray-100" readonly placeholder="Kerja">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">&nbsp;</label>
                                <input type="text" id="supervisi-day-count-holiday" class="w-full p-2 border-gray-300 rounded-lg bg-gray-100" readonly placeholder="Libur">
                            </div>
                        </div>
                        <div>
                            <label for="supervisi-description" class="block text-sm font-medium text-gray-600 mb-1">6. Ket. Tambahan</label>
                            <input type="text" id="supervisi-description" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="(Opsional)">
                        </div>
                        <div class="lg:col-span-4">
                            <label for="supervisi-total-amount" class="block text-sm font-medium text-gray-600 mb-1">Total Biaya Supervisi</label>
                            <input type="text" id="supervisi-total-amount" class="w-full p-2 border-gray-300 rounded-lg bg-gray-100 font-bold" readonly>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end space-x-2 mt-6">
                    <button type="submit" id="add-expense-btn" class="btn btn-primary"><i class="fas fa-plus mr-2"></i>Tambah</button>
                    <button type="button" id="cancel-edit-btn" class="btn btn-secondary hidden"><i class="fas fa-times mr-2"></i>Batal</button>
                </div>
            </form>
        </div>

        <!-- Actions & History Section -->
        <div class="card p-6">
             <div class="flex flex-wrap justify-between items-center gap-4">
                <h2 class="text-xl font-semibold text-gray-700">Laporan & Riwayat</h2>
                <div class="flex items-center gap-2">
                    <button id="preview-report-btn" class="btn btn-primary"><i class="fas fa-eye mr-2"></i>Preview Laporan</button>
                    <button id="export-csv-btn" class="btn btn-secondary"><i class="fas fa-file-csv mr-2"></i>Unduh Cepat CSV</button>
                </div>
            </div>
            <div class="overflow-x-auto mt-4">
                <table class="w-full text-left">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="p-3 text-sm font-semibold text-gray-600">Tanggal/Periode</th>
                            <th class="p-3 text-sm font-semibold text-gray-600">Keterangan</th>
                            <th class="p-3 text-sm font-semibold text-gray-600">Kategori</th>
                            <th class="p-3 text-sm font-semibold text-gray-600 text-right">Jumlah</th>
                            <th class="p-3 text-sm font-semibold text-gray-600 text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="expense-table-body"></tbody>
                </table>
                <p id="no-data-message" class="text-center text-gray-500 py-8">Belum ada data pengeluaran.</p>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-container bg-white w-full max-w-md rounded-lg shadow-lg p-6 transform scale-95">
            <h3 id="modal-title" class="text-lg font-bold text-gray-800 mb-4"></h3>
            <p id="modal-message" class="text-gray-600 mb-6"></p>
            <div id="modal-actions" class="flex justify-end space-x-3">
                <button id="modal-cancel" class="btn btn-secondary">Batal</button>
                <button id="modal-confirm" class="btn btn-primary">OK</button>
            </div>
        </div>
    </div>

    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/id.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- DOM Elements ---
    const projectInfoFields = { name: document.getElementById('project-name'), location: document.getElementById('project-location'), personnel: document.getElementById('project-personnel'), activity: document.getElementById('project-activity') };
    const initialBudgetInput = document.getElementById('initial-budget');
    const budgetDateInput = document.getElementById('budget-date');
    const setBudgetBtn = document.getElementById('set-budget-btn');
    const summaryBudget = document.getElementById('summary-budget');
    const summaryExpenses = document.getElementById('summary-expenses');
    const summaryBalance = document.getElementById('summary-balance');
    const expenseForm = document.getElementById('expense-form');
    const formTitle = document.getElementById('form-title');
    const expenseIdInput = document.getElementById('expense-id');
    const expenseCategoryInput = document.getElementById('expense-category');
    const addExpenseBtn = document.getElementById('add-expense-btn');
    const cancelEditBtn = document.getElementById('cancel-edit-btn');
    const expenseTableBody = document.getElementById('expense-table-body');
    const noDataMessage = document.getElementById('no-data-message');
    const exportCsvBtn = document.getElementById('export-csv-btn');
    const previewReportBtn = document.getElementById('preview-report-btn');
    const standardInputs = document.getElementById('standard-inputs');
    const supervisiInputs = document.getElementById('supervisi-inputs');
    const standardDate = document.getElementById('standard-date');
    const standardDescription = document.getElementById('standard-description');
    const standardDescriptionLabel = document.getElementById('standard-description-label');
    const standardAmount = document.getElementById('standard-amount');
    const supervisiName = document.getElementById('supervisi-name');
    const supervisiStartDate = document.getElementById('supervisi-start-date');
    const supervisiEndDate = document.getElementById('supervisi-end-date');
    const supervisiRateWork = document.getElementById('supervisi-rate-work');
    const supervisiRateHoliday = document.getElementById('supervisi-rate-holiday');
    const supervisiDayCountWork = document.getElementById('supervisi-day-count-work');
    const supervisiDayCountHoliday = document.getElementById('supervisi-day-count-holiday');
    const supervisiDescription = document.getElementById('supervisi-description');
    const supervisiTotalAmount = document.getElementById('supervisi-total-amount');
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalMessage = document.getElementById('modal-message');
    const modalConfirm = document.getElementById('modal-confirm');
    const modalCancel = document.getElementById('modal-cancel');

    // --- App State ---
    let state = {
        projectInfo: { name: '', location: '', personnel: '', activity: '' },
        budget: { amount: 0, date: '' },
        expenses: [],
        editingId: null,
        holidays: {}
    };
    let confirmCallback = null;

    // --- Modal Logic ---
    const showModal = (title, message, type = 'alert', onConfirm = null) => {
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        confirmCallback = onConfirm;

        if (type === 'confirm') {
            modalCancel.classList.remove('hidden');
            modalConfirm.textContent = 'Ya, Hapus';
        } else {
            modalCancel.classList.add('hidden');
            modalConfirm.textContent = 'OK';
        }
        modal.classList.remove('hidden');
        setTimeout(() => modal.classList.remove('opacity-0'), 10);
        setTimeout(() => modal.querySelector('.modal-container').classList.remove('scale-95'), 10);
    };

    const hideModal = () => {
        modal.classList.add('opacity-0');
        modal.querySelector('.modal-container').classList.add('scale-95');
        setTimeout(() => modal.classList.add('hidden'), 200);
    };

    modalConfirm.addEventListener('click', () => {
        if (confirmCallback) {
            confirmCallback();
        }
        hideModal();
    });
    modalCancel.addEventListener('click', hideModal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            hideModal();
        }
    });

    // --- Utility Functions ---
    const parseCurrency = (value) => parseFloat(String(value).replace(/[^\d]/g, '')) || 0;
    const formatToCurrency = (amount) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
    const formatForInputCurrency = (amount) => amount > 0 ? 'Rp ' + new Intl.NumberFormat('id-ID').format(amount) : '';
    
    const formatDateForReport = (dateString, options = { day: '2-digit', month: 'short', year: 'numeric' }) => {
        if (!dateString) return '';
        const [year, month, day] = dateString.split('-');
        const date = new Date(year, month - 1, day);
        return date.toLocaleDateString('id-ID', options);
    };
    
    const formatDateForInput = (dateString) => {
        if (!dateString || dateString.length !== 10) return '';
        const [year, month, day] = dateString.split('-');
        return `${day}/${month}/${year}`;
    };

    const parseDateFromInput = (str) => {
        if (!str || !/^\d{2}\/\d{2}\/\d{4}$/.test(str)) return null;
        const [day, month, year] = str.split('/').map(Number);
        if (year < 1900 || year > 2100 || month === 0 || month > 12) return null;
        const date = new Date(year, month - 1, day);
        if (date.getFullYear() !== year || date.getMonth() + 1 !== month || date.getDate() !== day) return null;
        return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    };

    const saveState = () => localStorage.setItem('expenseTrackerState', JSON.stringify(state));
    const loadState = () => {
        const savedState = localStorage.getItem('expenseTrackerState');
        if (savedState) {
            state = JSON.parse(savedState);
            state.expenses = state.expenses || [];
        }
    };
    function formatCurrencyInput(e) {
        const input = e.target;
        const value = parseCurrency(input.value);
        input.value = formatForInputCurrency(value);
    }
    
    function validateDateInput(e) {
        const input = e.target;
        if (input.value && !parseDateFromInput(input.value)) {
            input.classList.add('border-red-500');
        } else {
            input.classList.remove('border-red-500');
        }
    }

    // --- Holiday API & Calculation ---
    async function fetchHolidays() {
        const currentYear = new Date().getFullYear();
        for (const year of [currentYear - 1, currentYear, currentYear + 1]) {
            if (state.holidays[year]) continue;
            try {
                const response = await fetch(`https://api-harilibur.vercel.app/api?year=${year}`);
                if (!response.ok) continue;
                const holidays = await response.json();
                state.holidays[year] = {};
                holidays.forEach(h => { 
                    if (h.is_national_holiday) {
                        state.holidays[year][h.holiday_date] = h.holiday_name; 
                    }
                });
            } catch (error) { 
                console.error(`Gagal mengambil data hari libur untuk tahun ${year}:`, error); 
            }
        }
    }

    const isNationalHoliday = (date) => {
        const year = date.getFullYear();
        const dateString = date.toISOString().slice(0, 10);
        return state.holidays[year] ? state.holidays[year][dateString] : null;
    };

    function getDayCounts(startDate, endDate) {
        if (!startDate || !endDate || startDate > endDate) {
            return { workCount: 0, holidayCount: 0, holidayDetails: [] };
        }
        let workCount = 0;
        let holidayCount = 0;
        let holidayDetails = [];
        let currentDate = new Date(startDate);
        while (currentDate <= endDate) {
            const dayOfWeek = currentDate.getDay();
            const holidayName = isNationalHoliday(currentDate);
            const userTimezoneOffset = currentDate.getTimezoneOffset() * 60000;
            const adjustedDate = new Date(currentDate.getTime() + userTimezoneOffset);

            if (dayOfWeek === 0 || holidayName) {
                holidayCount++;
                if (holidayName) {
                    const dateString = adjustedDate.toISOString().slice(0, 10);
                    holidayDetails.push({ date: dateString, name: holidayName });
                }
            } else {
                workCount++;
            }
            currentDate.setDate(currentDate.getDate() + 1);
        }
        return { workCount, holidayCount, holidayDetails };
    }

    function calculateSupervisiTotal() {
        const startDateStr = parseDateFromInput(supervisiStartDate.value);
        const endDateStr = parseDateFromInput(supervisiEndDate.value);
        if (!startDateStr || !endDateStr) {
            supervisiDayCountWork.value = `0 hr kerja`;
            supervisiDayCountHoliday.value = `0 hr libur`;
            supervisiTotalAmount.value = '';
            return;
        }
        const startDate = new Date(`${startDateStr}T00:00:00`);
        const endDate = new Date(`${endDateStr}T00:00:00`);
        
        const { workCount, holidayCount } = getDayCounts(startDate, endDate);

        supervisiDayCountWork.value = `${workCount} hr kerja`;
        supervisiDayCountHoliday.value = `${holidayCount} hr libur`;

        const rateWork = parseCurrency(supervisiRateWork.value);
        const rateHoliday = parseCurrency(supervisiRateHoliday.value);
        const total = (workCount * rateWork) + (holidayCount * rateHoliday);
        supervisiTotalAmount.value = formatForInputCurrency(total);
    }

    // --- Render Functions ---
    const renderSummary = () => {
        const totalExpenses = state.expenses.reduce((sum, exp) => sum + exp.amount, 0);
        const balance = state.budget.amount - totalExpenses;
        summaryBudget.textContent = formatToCurrency(state.budget.amount);
        summaryExpenses.textContent = formatToCurrency(totalExpenses);
        summaryBalance.textContent = formatToCurrency(balance);
        summaryBalance.classList.toggle('text-red-600', balance < 0);
        summaryBalance.classList.toggle('text-green-600', balance >= 0);
    };

    const renderTable = () => {
        expenseTableBody.innerHTML = '';
        const hasExpenses = state.expenses.length > 0;
        noDataMessage.classList.toggle('hidden', hasExpenses);
        
        if (hasExpenses) {
            const sorted = [...state.expenses].sort((a, b) => new Date(b.date) - new Date(a.date));
            sorted.forEach(exp => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-50';
                
                const dateCell = document.createElement('td');
                dateCell.className = 'p-3 align-top';
                dateCell.textContent = exp.isPeriod ? `${formatDateForReport(exp.date)} - ${formatDateForReport(exp.endDate)}` : formatDateForReport(exp.date);

                const descCell = document.createElement('td');
                descCell.className = 'p-3 align-top';
                let descriptionHtml = exp.description;
                if (exp.category === 'Uang Supervisi' && exp.details?.holidayDetails?.length > 0) {
                    const holidayList = exp.details.holidayDetails.map(h => 
                        `<li>${formatDateForReport(h.date, {day: 'numeric', month: 'short'})}: ${h.name}</li>`
                    ).join('');
                    descriptionHtml += `<ul class="text-xs text-gray-500 mt-1 pl-4 list-disc">Ket. Libur:${holidayList}</ul>`;
                }
                descCell.innerHTML = descriptionHtml;

                const categoryCell = document.createElement('td');
                categoryCell.className = 'p-3 align-top';
                categoryCell.innerHTML = `<span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800 whitespace-nowrap">${exp.category}</span>`;

                const amountCell = document.createElement('td');
                amountCell.className = 'p-3 align-top text-right font-semibold';
                amountCell.textContent = formatToCurrency(exp.amount);

                const actionCell = document.createElement('td');
                actionCell.className = 'p-3 align-top text-center';
                const actionId = exp.groupId || exp.id;

                const editBtn = document.createElement('button');
                editBtn.className = 'text-blue-500 hover:text-blue-700 mr-2';
                editBtn.title = 'Edit';
                editBtn.innerHTML = '<i class="fas fa-pencil-alt"></i>';
                editBtn.addEventListener('click', () => handleEdit(actionId));

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'text-red-500 hover:text-red-700';
                deleteBtn.title = 'Hapus';
                deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                deleteBtn.addEventListener('click', () => handleDelete(actionId));

                actionCell.append(editBtn, deleteBtn);
                row.append(dateCell, descCell, categoryCell, amountCell, actionCell);
                expenseTableBody.appendChild(row);
            });
        }
    };

    const renderProjectInfo = () => {
        for (const key in projectInfoFields) {
            projectInfoFields[key].value = state.projectInfo[key] || '';
        }
    };

    const renderBudget = () => {
        const hasBudget = state.budget.amount > 0;
        initialBudgetInput.value = formatForInputCurrency(state.budget.amount);
        budgetDateInput.value = formatDateForInput(state.budget.date);
        initialBudgetInput.disabled = hasBudget;
        budgetDateInput.disabled = hasBudget;
        setBudgetBtn.innerHTML = hasBudget ? '<i class="fas fa-edit mr-2"></i>Ubah Budget' : '<i class="fas fa-save mr-2"></i>Atur Budget';
    };

    const renderAll = () => {
        renderProjectInfo();
        renderBudget();
        renderSummary();
        renderTable();
    };

    // --- Form Logic ---
    function updateFormUI(category) {
        standardInputs.classList.remove('active');
        supervisiInputs.classList.remove('active');
        standardDescriptionLabel.textContent = '3. Keterangan';
        standardDescription.placeholder = 'Detail pengeluaran';
        
        if (category === 'Uang Supervisi') {
            supervisiInputs.classList.add('active');
            calculateSupervisiTotal();
        } else if (category === 'Lainnya') {
            standardInputs.classList.add('active');
            standardDescriptionLabel.textContent = '3. Ketik Kategori & Keterangan';
            standardDescription.placeholder = 'Contoh: Biaya Cetak Dokumen Proyek';
        } else if (category) {
            standardInputs.classList.add('active');
        }
    }

    function resetForm() {
        expenseForm.reset();
        state.editingId = null;
        expenseIdInput.value = '';
        formTitle.textContent = 'Tambah Pengeluaran Baru';
        addExpenseBtn.innerHTML = '<i class="fas fa-plus mr-2"></i>Tambah';
        cancelEditBtn.classList.add('hidden');
        updateFormUI('');
        standardDate.value = formatDateForInput(new Date().toISOString().slice(0, 10));
        [budgetDateInput, standardDate, supervisiStartDate, supervisiEndDate].forEach(el => el.classList.remove('border-red-500'));
    }

    // --- Event Handlers ---
    Object.keys(projectInfoFields).forEach(key => {
        projectInfoFields[key].addEventListener('blur', (e) => {
            state.projectInfo[key] = e.target.value;
            saveState();
        });
    });

    [initialBudgetInput, standardAmount, supervisiRateWork, supervisiRateHoliday].forEach(input => {
        input.addEventListener('input', formatCurrencyInput);
    });

    [budgetDateInput, standardDate, supervisiStartDate, supervisiEndDate].forEach(input => {
        input.addEventListener('blur', validateDateInput);
    });

    setBudgetBtn.addEventListener('click', () => {
        if (initialBudgetInput.disabled) {
            initialBudgetInput.disabled = false;
            budgetDateInput.disabled = false;
            setBudgetBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Simpan Perubahan';
            initialBudgetInput.focus();
        } else {
            const amount = parseCurrency(initialBudgetInput.value);
            const date = parseDateFromInput(budgetDateInput.value);
            if (amount > 0 && date) {
                state.budget = { amount, date };
                saveState();
                renderAll();
            } else { 
                showModal('Input Tidak Valid', 'Mohon isi jumlah budget dan tanggal (dd/mm/yyyy) dengan benar.'); 
            }
        }
    });

    expenseCategoryInput.addEventListener('change', (e) => updateFormUI(e.target.value));
    
    [supervisiStartDate, supervisiEndDate, supervisiRateWork, supervisiRateHoliday].forEach(el => {
        el.addEventListener('input', calculateSupervisiTotal);
    });

    expenseForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const category = expenseCategoryInput.value;
        if (!category) { 
            showModal('Input Kurang', 'Mohon pilih kategori pengeluaran.'); 
            return; 
        }

        if (state.editingId) {
            state.expenses = state.expenses.filter(exp => (exp.groupId || exp.id) !== state.editingId);
        }
        
        if (category === 'Uang Supervisi') {
            const name = supervisiName.value.trim();
            const startDate = parseDateFromInput(supervisiStartDate.value);
            const endDate = parseDateFromInput(supervisiEndDate.value);
            
            if (!name || !startDate || !endDate) {
                showModal('Input Tidak Lengkap', 'Mohon lengkapi Nama Supervisi dan Periode Tanggal (dd/mm/yyyy).');
                return;
            }
            
            const { workCount, holidayCount, holidayDetails } = getDayCounts(new Date(`${startDate}T00:00:00`), new Date(`${endDate}T00:00:00`));
            const rateWork = parseCurrency(supervisiRateWork.value);
            const rateHoliday = parseCurrency(supervisiRateHoliday.value);

            if (workCount <= 0 && holidayCount <= 0) {
                 showModal('Input Tidak Valid', 'Periode tidak valid atau tidak ada hari untuk dihitung.');
                 return;
            }
            
            const groupId = state.editingId || `group-${new Date().getTime()}`;
            const additionalDesc = supervisiDescription.value.trim();
            const description = `Uang Supervisi ${name} (Kerja: ${workCount} hr, Libur: ${holidayCount} hr)${additionalDesc ? ` - ${additionalDesc}` : ''}`;
            
            const totalAmount = (workCount * rateWork) + (holidayCount * rateHoliday);
            
            if (totalAmount > 0) {
                 state.expenses.push({
                    id: `exp-${new Date().getTime()}`,
                    groupId: groupId,
                    isPeriod: true, 
                    date: startDate, 
                    endDate: endDate,
                    description: description,
                    amount: totalAmount, 
                    category: 'Uang Supervisi',
                    details: { name, description: additionalDesc, rateWork, rateHoliday, workCount, holidayCount, holidayDetails }
                });
            }

        } else { // Standard Expense
            const description = standardDescription.value.trim();
            const amount = parseCurrency(standardAmount.value);
            const date = parseDateFromInput(standardDate.value);
            if (!date || !description || amount <= 0) { 
                showModal('Input Tidak Lengkap', 'Mohon lengkapi Tanggal (dd/mm/yyyy), Keterangan, dan Jumlah.'); 
                return; 
            }
            const newExpense = {
                id: state.editingId || `exp-${new Date().getTime()}`,
                isPeriod: false, 
                date: date, 
                description, 
                amount,
                category: category === 'Lainnya' ? description.split(' ')[0] : category
            };
            state.expenses.push(newExpense);
        }
        saveState();
        renderAll();
        resetForm();
    });

    cancelEditBtn.addEventListener('click', resetForm);

    window.handleEdit = (id) => {
        let expenseToEdit = state.expenses.find(exp => exp.id === id || exp.groupId === id);
        if (!expenseToEdit) return;

        state.editingId = id;
        
        if (expenseToEdit.groupId) {
            const details = expenseToEdit.details;
            expenseCategoryInput.value = 'Uang Supervisi';
            updateFormUI('Uang Supervisi');

            supervisiName.value = details.name;
            supervisiStartDate.value = formatDateForInput(expenseToEdit.date);
            supervisiEndDate.value = formatDateForInput(expenseToEdit.endDate);
            supervisiDescription.value = details.description;
            supervisiRateWork.value = formatForInputCurrency(details.rateWork);
            supervisiRateHoliday.value = formatForInputCurrency(details.rateHoliday);
            calculateSupervisiTotal();

        } else {
            const cat = expenseToEdit.category;
            const isStandardCat = Array.from(expenseCategoryInput.options).some(opt => opt.value === cat);
            expenseCategoryInput.value = isStandardCat ? cat : 'Lainnya';
            updateFormUI(expenseCategoryInput.value);
            
            standardDate.value = formatDateForInput(expenseToEdit.date);
            standardDescription.value = expenseToEdit.description;
            standardAmount.value = formatForInputCurrency(expenseToEdit.amount);
        }
        
        formTitle.textContent = 'Edit Data Pengeluaran';
        addExpenseBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Simpan Perubahan';
        cancelEditBtn.classList.remove('hidden');
        window.scrollTo({ top: expenseForm.offsetTop - 20, behavior: 'smooth' });
    };

    window.handleDelete = (id) => {
        let expenseToDelete = state.expenses.find(exp => exp.id === id || exp.groupId === id);
        if (!expenseToDelete) return;

        const isGroup = !!expenseToDelete.groupId;
        let confirmMessage = isGroup 
            ? 'Ini akan menghapus seluruh entri supervisi terkait. Yakin?'
            : 'Apakah Anda yakin ingin menghapus data ini?';

        showModal('Konfirmasi Hapus', confirmMessage, 'confirm', () => {
            state.expenses = state.expenses.filter(exp => (exp.groupId || exp.id) !== id);
            if (state.editingId === id) {
                resetForm();
            }
            saveState();
            renderAll();
        });
    };
    
    function getCsvContent(data) {
        let csvContent = "INFORMASI PROYEK\r\n";
        csvContent += `Proyek,"${data.projectInfo.name}"\r\n`;
        csvContent += `Lokasi,"${data.projectInfo.location}"\r\n`;
        csvContent += `Kegiatan,"${data.projectInfo.activity}"\r\n`;
        csvContent += `Personil,"${data.projectInfo.personnel}"\r\n\r\n`;
        csvContent += "REKAPITULASI PENGELUARAN UANG\r\n";
        csvContent += `Tanggal Diterima,"${formatDateForReport(data.budget.date)}"\r\n\r\n`;
        csvContent += "No.,Uraian,Debet,Kredit\r\n";
        csvContent += `1,"Uang Diterima Tgl ${formatDateForReport(data.budget.date)}",${data.budget.amount},\r\n`;
        
        const sortedExpenses = [...data.expenses].sort((a, b) => new Date(a.date) - new Date(b.date));
        sortedExpenses.forEach((exp, index) => {
            const row = [`${index + 2}`, `"${exp.description.replace(/"/g, '""')}"`, ``, exp.amount].join(",");
            csvContent += row + "\r\n";
        });

        const totalExpenses = data.expenses.reduce((sum, exp) => sum + exp.amount, 0);
        const balance = data.budget.amount - totalExpenses;
        csvContent += `\r\n,Total,${data.budget.amount},${totalExpenses}\r\n`;
        csvContent += `,Balanced,,"${balance > 0 ? balance : '(' + Math.abs(balance) + ')'}"\r\n`;
        return csvContent;
    }

    function downloadCsv(data) {
        const csvContent = getCsvContent(data);
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        const fileName = data.projectInfo.activity ? data.projectInfo.activity.replace(/\s/g, '_') : 'laporan';
        link.setAttribute("href", url);
        link.setAttribute("download", `laporan_pengeluaran_${fileName}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    exportCsvBtn.addEventListener('click', () => downloadCsv(state));

    previewReportBtn.addEventListener('click', () => {
        const totalExpenses = state.expenses.reduce((sum, exp) => sum + exp.amount, 0);
        const balance = state.budget.amount - totalExpenses;
        const logoUrl = "https://raw.githubusercontent.com/krisandi89/rekap/main/LOGO%20MULTIBANGUN%20(Primary).png";
        
        const sortedExpenses = [...state.expenses].sort((a, b) => new Date(a.date) - new Date(b.date));

        const expenseRowsHTML = sortedExpenses.map((exp, index) => {
            let descriptionHtml = exp.description;
            if (exp.category === 'Uang Supervisi' && exp.details?.holidayDetails?.length > 0) {
                const holidayList = exp.details.holidayDetails.map(h => 
                    `<li>${formatDateForReport(h.date, {day: 'numeric', month: 'short'})}: ${h.name}</li>`
                ).join('');
                descriptionHtml += `<br/><div style="font-size: 10px; color: #555; padding-left: 10px;">Ket. Libur:<ul style="margin: 0; padding-left: 15px;">${holidayList}</ul></div>`;
            }
            return `
                <tr>
                    <td class="text-center">${index + 2}</td>
                    <td>${descriptionHtml}</td>
                    <td class="text-right">-</td>
                    <td class="text-right">${formatToCurrency(exp.amount)}</td>
                </tr>
            `;
        }).join('');

        const reportHTML = `
            <!DOCTYPE html>
            <html lang="id">
            <head>
                <meta charset="UTF-8">
                <title>Laporan Pengeluaran - ${state.projectInfo.name || 'Proyek'}</title>
                <script src="https://cdn.tailwindcss.com"><\/script>
                <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
                <style>
                    body { font-family: 'Inter', sans-serif; }
                    .a4-container {
                        width: 210mm;
                        min-height: 297mm;
                        margin: 2rem auto;
                        padding: 1.5rem;
                        box-shadow: 0 0 10px rgba(0,0,0,0.1);
                        background: white;
                        border: 1px solid #ddd;
                    }
                    table, th, td {
                        border: 1px solid black;
                        border-collapse: collapse;
                    }
                    th, td {
                        padding: 8px;
                        text-align: left;
                        vertical-align: top;
                    }
                    .no-border-table, .no-border-table tr, .no-border-table td {
                        border: none;
                        padding: 2px 4px;
                    }
                    .report-header {
                        position: relative;
                        text-align: center;
                        padding-bottom: 1rem;
                        margin-bottom: 1rem;
                        border-bottom: 2px solid black;
                    }
                    .report-header img {
                        position: absolute;
                        top: 50%;
                        transform: translateY(-50%);
                        left: 0;
                        height: 28px; /* Logo diperkecil 30% dari 40px */
                    }
                    .report-header h1 {
                        margin: 0;
                        padding: 0;
                        line-height: 28px; /* Disesuaikan dengan tinggi logo */
                    }
                     @media print {
                        body { -webkit-print-color-adjust: exact; print-color-adjust: exact; margin: 0; }
                        .no-print { display: none !important; }
                        .a4-container { margin: 0; box-shadow: none; border: none; }
                    }
                </style>
            </head>
            <body class="bg-gray-200">
                <div class="a4-container">
                    <header class="report-header">
                        <img src="${logoUrl}" alt="Logo Multibangun">
                        <h1 class="text-xl font-bold uppercase">Rekapitulasi Pengeluaran Uang</h1>
                    </header>
                    
                    <section class="mb-6 text-sm">
                        <table class="w-full no-border-table">
                           <tr><td class="w-1/4 font-semibold">Proyek</td><td>: ${state.projectInfo.name || '-'}</td></tr>
                           <tr><td class="w-1/4 font-semibold">Lokasi</td><td>: ${state.projectInfo.location || '-'}</td></tr>
                           <tr><td class="w-1/4 font-semibold">Kegiatan</td><td>: ${state.projectInfo.activity || '-'}</td></tr>
                           <tr><td class="w-1/4 font-semibold">Personil</td><td>: ${state.projectInfo.personnel || '-'}</td></tr>
                        </table>
                    </section>

                    <section>
                        <table class="w-full text-sm">
                            <thead class="bg-gray-200">
                                <tr class="font-semibold text-center">
                                    <th class="w-12">No.</th>
                                    <th>Uraian</th>
                                    <th class="w-40">Debet</th>
                                    <th class="w-40">Kredit</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="text-center">1</td>
                                    <td>Uang Diterima Tgl ${formatDateForReport(state.budget.date)}</td>
                                    <td class="text-right">${formatToCurrency(state.budget.amount)}</td>
                                    <td class="text-right">-</td>
                                </tr>
                                ${expenseRowsHTML}
                                ${state.expenses.length === 0 ? '<tr><td colspan="4" class="text-center p-8 text-gray-500">Tidak ada data pengeluaran.</td></tr>' : ''}
                            </tbody>
                            <tfoot>
                                <tr class="font-semibold bg-gray-200">
                                    <td colspan="2" class="text-center">Total</td>
                                    <td class="text-right">${formatToCurrency(state.budget.amount)}</td>
                                    <td class="text-right">${formatToCurrency(totalExpenses)}</td>
                                </tr>
                                <tr class="font-semibold bg-gray-200">
                                    <td colspan="2" class="text-center">Balanced</td>
                                    <td class="text-right font-bold" colspan="2">${formatToCurrency(balance)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </section>
                    
                    <footer class="mt-16 flex justify-end text-sm">
                        <div class="text-center">
                            <p>Jakarta, ${new Date().toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' })}</p>
                            <p class="mb-16">Yang mengajukan,</p>
                            <p class="font-semibold underline">${state.projectInfo.personnel || '( Nama Personil )'}</p>
                        </div>
                    </footer>
                </div>
                <div class="max-w-5xl mx-auto text-center p-4 no-print">
                     <button onclick="window.print()" class="btn btn-primary"><i class="fas fa-print mr-2"></i>Cetak Laporan</button>
                     <button onclick="window.close()" class="btn btn-secondary"><i class="fas fa-times mr-2"></i>Tutup Preview</button>
                </div>
            </body>
            </html>
        `;
        const reportWindow = window.open('', '_blank');
        reportWindow.document.write(reportHTML);
        reportWindow.document.close();
    });

    // --- Initial Load ---
    async function init() {
        const flatpickrConfig = {
            dateFormat: "d/m/Y",
            locale: "id"
        };
        flatpickr("#budget-date", flatpickrConfig);
        flatpickr("#standard-date", flatpickrConfig);
        flatpickr("#supervisi-start-date", flatpickrConfig);
        flatpickr("#supervisi-end-date", flatpickrConfig);
        
        loadState();
        await fetchHolidays();
        renderAll();
        resetForm();
    }
    
    init();
});
</script>
</body>
</html>
